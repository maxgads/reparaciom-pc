<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Reparaciones La Plata</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-tools me-2"></i>Admin - Reparaciones La Plata</a>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
                <i class="bi bi-box-arrow-right me-1"></i>Cerrar Sesión
            </button>
        </div>
    </nav>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Acceso Administrador</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div id="loginError" class="alert alert-danger d-none">
                            Usuario o contraseña incorrectos
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-key me-2"></i>Ingresar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4" id="adminContent" style="display: none;">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="totalVisits">0</h4>
                                <p class="card-text">Visitas Totales</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-eye" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="totalContacts">0</h4>
                                <p class="card-text">Consultas Recibidas</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="todayVisits">0</h4>
                                <p class="card-text">Visitas Hoy</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-calendar-day" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="whatsappClicks">0</h4>
                                <p class="card-text">Clicks WhatsApp</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-whatsapp" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up me-2"></i>Visitas por Día (Últimos 7 días)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="visitsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart me-2"></i>Páginas Más Visitadas</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="pagesChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Messages -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-envelope me-2"></i>Consultas Recientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Equipo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTable">
                            <!-- Contacts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Credenciales de acceso (en producción esto debería estar en el backend)
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'repara2024'
        };

        // Check if user is logged in
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showAdminContent();
            } else {
                showLoginModal();
            }
        }

        function showLoginModal() {
            document.getElementById('adminContent').style.display = 'none';
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        function showAdminContent() {
            document.getElementById('adminContent').style.display = 'block';
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            if (loginModal) loginModal.hide();
            loadDashboardData();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('loginError').classList.add('d-none');
                showAdminContent();
            } else {
                document.getElementById('loginError').classList.remove('d-none');
            }
        });

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        // Load dashboard data (real data from API)
        async function loadDashboardData() {
            try {
                // Fetch real analytics data
                const response = await fetch('/api/analytics/stats');
                if (!response.ok) throw new Error('Failed to fetch analytics');
                
                const data = await response.json();
                const stats = data.stats;

                // Update dashboard cards with real data
                document.getElementById('totalVisits').textContent = stats.totalVisits || 0;
                document.getElementById('totalContacts').textContent = stats.totalContacts || 0;
                document.getElementById('todayVisits').textContent = stats.todayVisits || 0;
                document.getElementById('whatsappClicks').textContent = stats.whatsappClicks || 0;

                // Load charts with real data
                loadVisitsChart(stats.visitsChart || []);
                loadPagesChart(stats.topPages || []);
                await loadContactsTable();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorMessage('Error cargando datos del dashboard');
                
                // Fallback to show zeros
                document.getElementById('totalVisits').textContent = '0';
                document.getElementById('totalContacts').textContent = '0';
                document.getElementById('todayVisits').textContent = '0';
                document.getElementById('whatsappClicks').textContent = '0';
            }
        }

        // Charts
        function loadVisitsChart(visitsData = []) {
            const ctx = document.getElementById('visitsChart').getContext('2d');
            
            // Preparar datos para los últimos 7 días
            const last7Days = [];
            const visitCounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayName = date.toLocaleDateString('es-ES', { weekday: 'short' });
                last7Days.push(dayName);
                
                const dayData = visitsData.find(d => d.date === dateStr);
                visitCounts.push(dayData ? dayData.visits : 0);
            }
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Visitas',
                        data: visitCounts,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadPagesChart(pagesData = []) {
            const ctx = document.getElementById('pagesChart').getContext('2d');
            
            // Mapear nombres de páginas amigables
            const pageNames = {
                '/': 'Inicio',
                '/index.html': 'Inicio',
                '/#servicios': 'Servicios',
                '/#contacto': 'Contacto',
                '/#sobre-mi': 'Sobre Mí',
                '/#galeria': 'Galería',
                '/admin.html': 'Admin'
            };
            
            let labels = [];
            let data = [];
            let colors = [
                'rgb(54, 162, 235)',
                'rgb(255, 99, 132)',
                'rgb(75, 192, 192)',
                'rgb(255, 205, 86)',
                'rgb(153, 102, 255)'
            ];
            
            if (pagesData.length > 0) {
                labels = pagesData.map(item => pageNames[item.page_path] || item.page_path);
                data = pagesData.map(item => item.views);
            } else {
                labels = ['Sin datos'];
                data = [1];
                colors = ['rgb(200, 200, 200)'];
            }
            
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        async function loadContactsTable() {
            try {
                const response = await fetch('/api/contact/list');
                const data = await response.json();
                
                const tableBody = document.getElementById('contactsTable');
                tableBody.innerHTML = '';
                
                if (data.success && data.contacts && data.contacts.length > 0) {
                    data.contacts.forEach(contact => {
                        const fecha = new Date(contact.created_at).toLocaleDateString('es-ES');
                        const estadoBadge = getStatusBadge(contact.status);
                        
                        const row = `
                            <tr>
                                <td>${fecha}</td>
                                <td>${contact.name}</td>
                                <td>${contact.email}</td>
                                <td>${contact.phone}</td>
                                <td>${contact.equipment_type}</td>
                                <td>${estadoBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" title="Ver detalles" onclick="showContactDetails(${contact.id})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" title="Marcar como contactado" onclick="updateContactStatus(${contact.id}, 'contacted')">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                No hay consultas aún. ¡Las primeras consultas aparecerán aquí!
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                const tableBody = document.getElementById('contactsTable');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-circle display-4 d-block mb-2"></i>
                            Error cargando consultas
                        </td>
                    </tr>
                `;
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { class: 'primary', text: 'Nuevo' },
                'contacted': { class: 'success', text: 'Contactado' },
                'resolved': { class: 'info', text: 'Resuelto' },
                'spam': { class: 'danger', text: 'Spam' }
            };
            
            const statusInfo = statusMap[status] || { class: 'secondary', text: status };
            return `<span class="badge bg-${statusInfo.class}">${statusInfo.text}</span>`;
        }

        function showContactDetails(contactId) {
            // TODO: Implementar modal con detalles del contacto
            alert(`Mostrando detalles del contacto ${contactId}`);
        }

        function updateContactStatus(contactId, newStatus) {
            // TODO: Implementar actualización de estado
            alert(`Actualizando estado del contacto ${contactId} a ${newStatus}`);
        }

        function showErrorMessage(message) {
            // Crear toast de error
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-exclamation-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => toast.remove(), 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>