#!/bin/bash

# Script para configurar DNS din√°mico con DuckDNS
# Incluye configuraci√≥n autom√°tica, verificaci√≥n y monitoreo

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

log_info "=== Configuraci√≥n de DNS Din√°mico (DuckDNS) ==="
echo

# Verificar archivo .env
if [ ! -f ".env" ]; then
    log_error "Archivo .env no encontrado"
    log_info "Configura el archivo .env antes de continuar"
    exit 1
fi

# Cargar variables de entorno
source .env

# 1. Configurar DuckDNS si no est√° configurado
if [ -z "$DUCKDNS_DOMAIN" ] || [ -z "$DUCKDNS_TOKEN" ]; then
    log_warning "Variables de DuckDNS no configuradas"
    echo
    log_info "Para configurar DuckDNS:"
    echo "1. Ve a https://www.duckdns.org/"
    echo "2. Inicia sesi√≥n con Google/GitHub/Twitter"
    echo "3. Crea un subdominio (ej: mi-servicio-pc)"
    echo "4. Copia el token que aparece en la p√°gina"
    echo
    
    read -p "¬øHas completado estos pasos? (s/N): " setup_done
    if [[ ! "$setup_done" =~ ^[sS]$ ]]; then
        log_info "Completa la configuraci√≥n en DuckDNS y vuelve a ejecutar este script"
        exit 1
    fi
    
    echo
    read -p "Ingresa tu subdominio de DuckDNS (sin .duckdns.org): " duckdns_domain
    read -p "Ingresa tu token de DuckDNS: " duckdns_token
    
    # Actualizar .env
    if grep -q "DUCKDNS_DOMAIN=" .env; then
        sed -i "s/DUCKDNS_DOMAIN=.*/DUCKDNS_DOMAIN=$duckdns_domain/" .env
    else
        echo "DUCKDNS_DOMAIN=$duckdns_domain" >> .env
    fi
    
    if grep -q "DUCKDNS_TOKEN=" .env; then
        sed -i "s/DUCKDNS_TOKEN=.*/DUCKDNS_TOKEN=$duckdns_token/" .env
    else
        echo "DUCKDNS_TOKEN=$duckdns_token" >> .env
    fi
    
    # Recargar variables
    source .env
    
    log_success "Configuraci√≥n de DuckDNS actualizada en .env"
fi

log_info "Dominio DuckDNS: $DUCKDNS_DOMAIN.duckdns.org"

# 2. Obtener IP p√∫blica actual
log_info "2. Detectando IP p√∫blica..."
CURRENT_IP=""

# Intentar varios servicios para obtener la IP
IP_SERVICES=(
    "https://ipv4.icanhazip.com"
    "https://api.ipify.org"
    "https://checkip.amazonaws.com"
    "https://ifconfig.me"
)

for service in "${IP_SERVICES[@]}"; do
    if CURRENT_IP=$(curl -s --max-time 5 "$service" 2>/dev/null); then
        # Validar que es una IP v√°lida
        if [[ $CURRENT_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            log_success "IP p√∫blica detectada: $CURRENT_IP"
            break
        fi
    fi
done

if [ -z "$CURRENT_IP" ]; then
    log_error "No se pudo detectar la IP p√∫blica"
    log_info "Verifica tu conexi√≥n a internet"
    exit 1
fi

# 3. Actualizar DuckDNS
log_info "3. Actualizando DNS en DuckDNS..."
DUCKDNS_URL="https://www.duckdns.org/update?domains=$DUCKDNS_DOMAIN&token=$DUCKDNS_TOKEN&ip=$CURRENT_IP"

RESPONSE=$(curl -s "$DUCKDNS_URL")

if [ "$RESPONSE" = "OK" ]; then
    log_success "DNS actualizado correctamente en DuckDNS"
else
    log_error "Error al actualizar DNS: $RESPONSE"
    log_info "Verifica tu dominio y token de DuckDNS"
    exit 1
fi

# 4. Crear script de actualizaci√≥n autom√°tica
log_info "4. Configurando actualizaci√≥n autom√°tica..."

# Script mejorado de actualizaci√≥n
cat > scripts/update-duckdns.sh << 'EOF'
#!/bin/bash

# Script de actualizaci√≥n autom√°tica de DuckDNS
# Incluye logging y verificaci√≥n de cambios

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
LOG_FILE="$BASE_DIR/logs/duckdns.log"
IP_FILE="$BASE_DIR/.last_ip"

# Crear directorio de logs si no existe
mkdir -p "$(dirname "$LOG_FILE")"

# Funci√≥n de logging
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Cargar variables de entorno
if [ -f "$BASE_DIR/.env" ]; then
    source "$BASE_DIR/.env"
else
    log_message "ERROR: Archivo .env no encontrado"
    exit 1
fi

# Verificar configuraci√≥n
if [ -z "$DUCKDNS_DOMAIN" ] || [ -z "$DUCKDNS_TOKEN" ]; then
    log_message "ERROR: Variables DUCKDNS_DOMAIN o DUCKDNS_TOKEN no configuradas"
    exit 1
fi

# Obtener IP p√∫blica actual
IP_SERVICES=(
    "https://ipv4.icanhazip.com"
    "https://api.ipify.org"
    "https://checkip.amazonaws.com"
    "https://ifconfig.me"
)

CURRENT_IP=""
for service in "${IP_SERVICES[@]}"; do
    if CURRENT_IP=$(curl -s --max-time 5 "$service" 2>/dev/null); then
        if [[ $CURRENT_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            break
        fi
    fi
done

if [ -z "$CURRENT_IP" ]; then
    log_message "ERROR: No se pudo obtener la IP p√∫blica"
    exit 1
fi

# Verificar si la IP cambi√≥
LAST_IP=""
if [ -f "$IP_FILE" ]; then
    LAST_IP=$(cat "$IP_FILE")
fi

if [ "$CURRENT_IP" = "$LAST_IP" ]; then
    # IP no cambi√≥, solo log cada hora
    CURRENT_HOUR=$(date +%H)
    if [ "$CURRENT_HOUR" = "00" ] || [ "$CURRENT_HOUR" = "12" ]; then
        log_message "INFO: IP sin cambios ($CURRENT_IP)"
    fi
    exit 0
fi

# IP cambi√≥, actualizar DuckDNS
log_message "INFO: IP cambi√≥ de '$LAST_IP' a '$CURRENT_IP', actualizando DNS..."

DUCKDNS_URL="https://www.duckdns.org/update?domains=$DUCKDNS_DOMAIN&token=$DUCKDNS_TOKEN&ip=$CURRENT_IP"
RESPONSE=$(curl -s --max-time 10 "$DUCKDNS_URL")

if [ "$RESPONSE" = "OK" ]; then
    log_message "SUCCESS: DNS actualizado correctamente ($CURRENT_IP)"
    echo "$CURRENT_IP" > "$IP_FILE"
    
    # Opcional: Webhook de notificaci√≥n (si est√° configurado)
    if [ ! -z "$WEBHOOK_URL" ]; then
        curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\":\"üåê DNS actualizado: $DUCKDNS_DOMAIN.duckdns.org -> $CURRENT_IP\"}" \
            >/dev/null 2>&1
    fi
else
    log_message "ERROR: Fallo al actualizar DNS - Respuesta: $RESPONSE"
    exit 1
fi
EOF

chmod +x scripts/update-duckdns.sh

# 5. Configurar cron job para actualizaci√≥n autom√°tica
log_info "5. Configurando actualizaci√≥n autom√°tica (cron)..."

# Eliminar trabajos anteriores de DuckDNS
crontab -l 2>/dev/null | grep -v "update-duckdns" | crontab -

# Agregar nuevo trabajo cada 5 minutos
(crontab -l 2>/dev/null; echo "*/5 * * * * cd $(pwd) && ./scripts/update-duckdns.sh") | crontab -

log_success "Cron job configurado (actualizaci√≥n cada 5 minutos)"

# 6. Configurar logrotate para logs de DNS
log_info "6. Configurando rotaci√≥n de logs..."

sudo tee /etc/logrotate.d/duckdns > /dev/null << EOF
$(pwd)/logs/duckdns.log {
    weekly
    missingok
    rotate 12
    compress
    notifempty
    create 644 $USER $USER
    su $USER $USER
}
EOF

# 7. Crear script de verificaci√≥n DNS
log_info "7. Creando herramientas de verificaci√≥n..."

cat > scripts/dns-check.sh << 'EOF'
#!/bin/bash

# Script para verificar el estado del DNS din√°mico

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
BASE_DIR="$(dirname "$SCRIPT_DIR")"

# Cargar variables de entorno
if [ -f "$BASE_DIR/.env" ]; then
    source "$BASE_DIR/.env"
else
    echo "Error: Archivo .env no encontrado"
    exit 1
fi

if [ -z "$DUCKDNS_DOMAIN" ]; then
    echo "Error: Variable DUCKDNS_DOMAIN no configurada"
    exit 1
fi

FULL_DOMAIN="${DUCKDNS_DOMAIN}.duckdns.org"

echo "=== Verificaci√≥n de DNS Din√°mico ==="
echo "Dominio: $FULL_DOMAIN"
echo

# 1. Obtener IP p√∫blica actual
echo "üåê Obteniendo IP p√∫blica actual..."
CURRENT_IP=$(curl -s https://api.ipify.org)
echo "IP p√∫blica: $CURRENT_IP"
echo

# 2. Resolver DNS del dominio
echo "üîç Resolviendo DNS..."
RESOLVED_IP=$(dig +short "$FULL_DOMAIN" @8.8.8.8 | tail -n1)

if [ -z "$RESOLVED_IP" ]; then
    echo "‚ùå No se pudo resolver el dominio"
    exit 1
fi

echo "IP del dominio: $RESOLVED_IP"
echo

# 3. Comparar IPs
if [ "$CURRENT_IP" = "$RESOLVED_IP" ]; then
    echo "‚úÖ DNS est√° sincronizado correctamente"
    STATUS="OK"
else
    echo "‚ö†Ô∏è  DNS no est√° sincronizado:"
    echo "  IP p√∫blica: $CURRENT_IP"
    echo "  IP en DNS:  $RESOLVED_IP"
    STATUS="MISMATCH"
fi

echo

# 4. Verificar √∫ltima actualizaci√≥n
if [ -f "$BASE_DIR/.last_ip" ]; then
    LAST_IP=$(cat "$BASE_DIR/.last_ip")
    echo "üìù √öltima IP guardada: $LAST_IP"
fi

if [ -f "$BASE_DIR/logs/duckdns.log" ]; then
    echo "üìã √öltima actualizaci√≥n:"
    tail -n 3 "$BASE_DIR/logs/duckdns.log"
fi

echo

# 5. Test de conectividad
echo "üîó Verificando conectividad..."
if timeout 10 curl -sf "http://$FULL_DOMAIN" >/dev/null 2>&1; then
    echo "‚úÖ Dominio accesible v√≠a HTTP"
else
    echo "‚ùå Dominio no accesible v√≠a HTTP"
fi

if timeout 10 curl -sf "https://$FULL_DOMAIN" >/dev/null 2>&1; then
    echo "‚úÖ Dominio accesible v√≠a HTTPS"
else
    echo "‚ö†Ô∏è  Dominio no accesible v√≠a HTTPS (puede ser normal si no hay SSL)"
fi

echo
echo "Estado general: $STATUS"
EOF

chmod +x scripts/dns-check.sh

# 8. Actualizar .env con el dominio completo si es necesario
if [ -z "$DOMAIN" ] || [ "$DOMAIN" != "${DUCKDNS_DOMAIN}.duckdns.org" ]; then
    log_info "8. Actualizando variable DOMAIN en .env..."
    
    if grep -q "DOMAIN=" .env; then
        sed -i "s/DOMAIN=.*/DOMAIN=${DUCKDNS_DOMAIN}.duckdns.org/" .env
    else
        echo "DOMAIN=${DUCKDNS_DOMAIN}.duckdns.org" >> .env
    fi
    
    # Actualizar BASE_URL tambi√©n
    if grep -q "BASE_URL=" .env; then
        sed -i "s/BASE_URL=.*/BASE_URL=https:\/\/${DUCKDNS_DOMAIN}.duckdns.org/" .env
    else
        echo "BASE_URL=https://${DUCKDNS_DOMAIN}.duckdns.org" >> .env
    fi
    
    log_success "Variables DOMAIN y BASE_URL actualizadas"
fi

# 9. Verificaci√≥n final
log_info "9. Verificando configuraci√≥n..."

# Esperar un poco para que se propague el DNS
sleep 10

# Verificar resoluci√≥n DNS
RESOLVED_IP=$(dig +short "${DUCKDNS_DOMAIN}.duckdns.org" @8.8.8.8 | tail -n1)

if [ "$RESOLVED_IP" = "$CURRENT_IP" ]; then
    log_success "DNS funcionando correctamente"
else
    log_warning "DNS puede tardar unos minutos en propagarse"
    log_info "IP actual: $CURRENT_IP"
    log_info "IP en DNS: $RESOLVED_IP"
fi

# 10. Informaci√≥n final
echo
log_success "=== CONFIGURACI√ìN DNS COMPLETADA ==="
echo
echo "üåê Dominio: ${DUCKDNS_DOMAIN}.duckdns.org"
echo "üìç IP actual: $CURRENT_IP"
echo "üîÑ Actualizaci√≥n: Autom√°tica (cada 5 minutos)"
echo "üìä Logs: logs/duckdns.log"
echo
log_info "URLs de acceso:"
echo "  ‚Ä¢ HTTP: http://${DUCKDNS_DOMAIN}.duckdns.org"
echo "  ‚Ä¢ HTTPS: https://${DUCKDNS_DOMAIN}.duckdns.org (despu√©s de configurar SSL)"
echo
log_info "Comandos √∫tiles:"
echo "  ‚Ä¢ Verificar DNS: ./scripts/dns-check.sh"
echo "  ‚Ä¢ Actualizar manualmente: ./scripts/update-duckdns.sh"
echo "  ‚Ä¢ Ver logs: tail -f logs/duckdns.log"
echo "  ‚Ä¢ Ver cron jobs: crontab -l"
echo
log_warning "PR√ìXIMOS PASOS:"
echo "‚Ä¢ Configura SSL con: ./scripts/ssl-setup.sh"
echo "‚Ä¢ El DNS puede tardar 5-10 minutos en propagarse completamente"
echo "‚Ä¢ Aseg√∫rate de configurar port forwarding en tu router"
echo

# Crear archivo de estado DNS
cat > .dns-status << EOF
DNS_CONFIGURED=true
DUCKDNS_DOMAIN=$DUCKDNS_DOMAIN
FULL_DOMAIN=${DUCKDNS_DOMAIN}.duckdns.org
CURRENT_IP=$CURRENT_IP
CONFIGURED_DATE=$(date)
AUTO_UPDATE=enabled
CRON_JOB=*/5 * * * *
EOF

log_success "Configuraci√≥n DNS completada exitosamente!"